/**
 * FALLBACK DATA для RETRO-PC STORE v3.3.2
 * Демонстрационные товары с реальными изображениями
 */

window.fallbackProducts = [
    {
        id: 1,
        name: "Intel 8086 CPU",
        price: "$89.99",
        description: "Легендарный 16-битный процессор 1978 года. Основа IBM PC и начало эры x86.",
        category: "processors",
        image: "assets/img/Intel_8086-2.jpg",
        condition: "Used - Excellent",
        year: "1978"
    },
    {
        id: 2,
        name: "Intel 8088 CPU", 
        price: "$79.99",
        description: "Процессор IBM PC (1981). 8-битная шина данных, совместим с 8086.",
        category: "processors",
        image: "assets/img/Intel_8088-2.jpg",
        condition: "Used - Good",
        year: "1979"
    },
    {
        id: 3,
        name: "Intel 8087 FPU",
        price: "$129.99",
        description: "Математический сопроцессор. Ускорение вычислений до 100x.",
        category: "processors",
        image: "assets/img/Intel_8087.jpg",
        condition: "Used - Excellent",
        year: "1980"
    },
    {
        id: 4,
        name: "Intel 80286 CPU",
        price: "$119.99",
        description: "16-битный процессор IBM PC AT (1984). Защищённый режим, до 16 МБ памяти.",
        category: "processors",
        image: "assets/img/fallback/chip-placeholder.svg",
        condition: "New Old Stock",
        year: "1982"
    },
    {
        id: 5,
        name: "IBM PC Motherboard",
        price: "$299.99",
        description: "Оригинальная материнская плата IBM PC 5150. С Intel 8088 @ 4.77 МГц.",
        category: "motherboards",
        image: "assets/img/fallback/chip-placeholder.svg",
        condition: "Used - Fair",
        year: "1981"
    },
    {
        id: 6,
        name: "64KB RAM Module",
        price: "$49.99",
        description: "Модуль памяти 64 КБ для IBM PC/XT. Девять чипов 4164.",
        category: "memory",
        image: "assets/img/fallback/chip-placeholder.svg",
        condition: "Used - Good",
        year: "1982"
    },
    {
        id: 7,
        name: "CGA Video Card",
        price: "$89.99",
        description: "IBM Color Graphics Adapter. 320x200 4 цвета или 640x200 монохром.",
        category: "video",
        image: "assets/img/fallback/chip-placeholder.svg",
        condition: "Used - Excellent",
        year: "1981"
    },
    {
        id: 8,
        name: "MDA Video Card",
        price: "$69.99",
        description: "Monochrome Display Adapter. 80x25 текстовый режим.",
        category: "video",
        image: "assets/img/fallback/chip-placeholder.svg",
        condition: "Used - Good",
        year: "1981"
    },
    {
        id: 9,
        name: "IBM PC Keyboard",
        price: "$159.99",
        description: "Легендарная клавиатура Model F. 83 клавиши, buckling spring.",
        category: "peripherals",
        image: "assets/img/fallback/chip-placeholder.svg",
        condition: "Used - Excellent",
        year: "1981"
    },
    {
        id: 10,
        name: "5.25\" Floppy Drive",
        price: "$79.99",
        description: "Дисковод 360 КБ для IBM PC/XT. Полувысотный формат.",
        category: "storage",
        image: "assets/img/fallback/chip-placeholder.svg",
        condition: "Used - Good",
        year: "1983"
    },
    {
        id: 11,
        name: "IBM PC XT Case",
        price: "$199.99",
        description: "Оригинальный корпус IBM PC XT. Металлический, с блоком питания 135W.",
        category: "cases",
        image: "assets/img/fallback/chip-placeholder.svg",
        condition: "Used - Fair",
        year: "1983"
    },
    {
        id: 12,
        name: "PC Speaker",
        price: "$19.99",
        description: "Монофонический динамик для PC. 1-битный звук через порт 61h.",
        category: "audio",
        image: "assets/img/fallback/chip-placeholder.svg",
        condition: "Used - Good",
        year: "1981"
    }
];
        images: {
            avif: "/assets/img/fallback/intel-8086.avif",
            webp: "/assets/img/fallback/intel-8086.webp", 
            jpg: "/assets/img/Intel_8086-2.jpg",
            alt: "Мікропроцесор Intel 8086 16-біт з 1978 року, керамічний DIP корпус"
        },
        
        // SEO та accessibility метадані
        seoMetadata: {
            description: "Оригінальний Intel 8086 - перший 16-бітний процесор Intel, що заклав основи архітектури x86",
            keywords: ["Intel 8086", "16-bit processor", "vintage CPU", "retro computing", "x86 architecture"],
            category: "Vintage Processors"
        },
        
        // Технічні характеристики для розширених сніпетів
        specifications: {
            architecture: "x86 16-bit",
            frequency: "5-10 MHz",
            dataWidth: "16-bit internal, 16-bit external",
            addressBus: "20-bit (1MB addressable)",
            transistors: "29,000",
            process: "3 μm nMOS"
        }
    },
    {
        id: 'intel-8088-ibm-pc',
        title: "Intel 8088 CPU - IBM PC Compatible Processor",
        currentPrice: "$75.50",
        condition: "Used - Good", 
        location: "Austin, TX",
        viewItemURL: "#demo-intel-8088",
        sku: "CPU-8088-002",
        brand: "Intel",
        yearManufactured: "1979",
        
        images: {
            avif: "/assets/img/fallback/intel-8088.avif",
            webp: "/assets/img/fallback/intel-8088.webp",
            jpg: "/assets/img/Intel_8088-2.jpg",
            alt: "Мікропроцесор Intel 8088, 8-бітна зовнішня шина, варіант 8086"
        },
        
        seoMetadata: {
            description: "Intel 8088 - серце оригінального IBM PC, 8-бітна зовнішня шина версія 8086",
            keywords: ["Intel 8088", "IBM PC", "8-bit external bus", "vintage processor"],
            category: "Vintage Processors"
        },
        
        specifications: {
            architecture: "x86 16-bit",
            frequency: "4.77-8 MHz",
            dataWidth: "16-bit internal, 8-bit external", 
            addressBus: "20-bit (1MB addressable)",
            transistors: "29,000",
            process: "3 μm nMOS"
        }
    },
    {
        id: 'intel-8087-fpu',
        title: "Intel 8087 Math Coprocessor FPU - Floating Point Unit",
        currentPrice: "$125.00",
        condition: "Used - Very Good",
        location: "Portland, OR", 
        viewItemURL: "#demo-intel-8087",
        sku: "FPU-8087-001",
        brand: "Intel",
        yearManufactured: "1980",
        
        images: {
            avif: "/assets/img/fallback/intel-8087.avif",
            webp: "/assets/img/fallback/intel-8087.webp",
            jpg: "/assets/img/Intel_8087.jpg",
            alt: "Intel 8087 співпроцесор з плаваючою комою для математичних обчислень"
        },
        
        seoMetadata: {
            description: "Intel 8087 FPU - перший математичний співпроцесор для x86, підтримка IEEE 754",
            keywords: ["Intel 8087", "math coprocessor", "FPU", "floating point", "IEEE 754"],
            category: "Coprocessors"
        },
        
        specifications: {
            architecture: "x87 FPU",
            dataTypes: "32, 64, 80-bit floating point",
            standards: "IEEE 754",
            functions: "Add, Sub, Mul, Div, Sqrt, Transcendental",
            precision: "64-bit mantissa",
            compatibility: "8086/8088 systems"
        }
    },
    {
        id: 'ibm-xt-motherboard',
        title: "IBM PC XT Motherboard - Complete Vintage System Board",
        currentPrice: "$299.99",
        condition: "Used - Fair",
        location: "Boston, MA",
        viewItemURL: "#demo-ibm-xt-board",
        sku: "MB-XT-001",
        brand: "IBM",
        yearManufactured: "1983",
        
        images: {
            avif: "/assets/img/fallback/ibm-xt-motherboard.avif",
            webp: "/assets/img/fallback/ibm-xt-motherboard.webp", 
            jpg: "/assets/img/fallback/ibm-xt-motherboard.jpg",
            alt: "Материнська плата IBM PC XT з сокетом 8088 CPU та слотами розширення"
        },
        
        seoMetadata: {
            description: "Оригінальна материнська плата IBM PC XT 1983 року з повним набором компонентів",
            keywords: ["IBM PC XT", "motherboard", "vintage motherboard", "8088 socket", "ISA slots"],
            category: "Motherboards"
        },
        
        specifications: {
            cpu: "Intel 8088 4.77 MHz",
            memory: "256KB standard, expandable to 640KB",
            expansionSlots: "8x ISA 8-bit slots",
            storage: "Built-in floppy controller, HDD controller",
            ports: "Keyboard, cassette interface",
            dimensions: "13.8 x 11.2 inches"
        }
    },
    {
        id: 'cga-graphics-card',
        title: "CGA Graphics Card - Color Graphics Adapter (1981)",
        currentPrice: "$149.95",
        condition: "Used - Good",
        location: "San Francisco, CA",
        viewItemURL: "#demo-cga-card",
        sku: "GPU-CGA-001",
        brand: "IBM",
        yearManufactured: "1981",
        
        images: {
            avif: "/assets/img/fallback/cga-graphics-card.avif",
            webp: "/assets/img/fallback/cga-graphics-card.webp",
            jpg: "/assets/img/fallback/cga-graphics-card.jpg",
            alt: "IBM Color Graphics Adapter (CGA) карта 1981 року"
        },
        
        seoMetadata: {
            description: "IBM CGA - перша кольорова графічна карта для PC, революційна технологія 1981 року",
            keywords: ["IBM CGA", "Color Graphics Adapter", "vintage graphics", "retro GPU", "1981"],
            category: "Graphics Cards"
        },
        
        specifications: {
            resolution: "320x200 (4 colors), 640x200 (monochrome)",
            colors: "16-color palette, 4 simultaneous",
            memory: "16KB video RAM",
            textModes: "40x25, 80x25 characters",
            connector: "Composite video, RGB",
            compatibility: "IBM PC/XT/AT"
        }
    },
    {
        id: 'ega-graphics-card',
        title: "EGA Graphics Card - Enhanced Graphics Adapter (1984)",
        currentPrice: "$199.99",
        condition: "Used - Excellent",
        location: "Seattle, WA",
        viewItemURL: "#demo-ega-card",
        sku: "GPU-EGA-001", 
        brand: "IBM",
        yearManufactured: "1984",
        
        images: {
            avif: "/assets/img/fallback/ega-graphics-card.avif",
            webp: "/assets/img/fallback/ega-graphics-card.webp",
            jpg: "/assets/img/fallback/ega-graphics-card.jpg",
            alt: "Enhanced Graphics Adapter (EGA) карта з роздільністю 640x350"
        },
        
        seoMetadata: {
            description: "IBM EGA - покращений графічний адаптер з підтримкою 640x350 та 16 кольорів",
            keywords: ["IBM EGA", "Enhanced Graphics Adapter", "640x350", "16 colors", "vintage graphics"],
            category: "Graphics Cards"
        },
        
        specifications: {
            resolution: "640x350 (16 colors), 640x200, 320x200",
            colors: "64-color palette, 16 simultaneous",
            memory: "256KB video RAM",
            textModes: "80x25, 80x43 characters",
            connector: "Enhanced RGB, Composite",
            compatibility: "Backward compatible with CGA"
        }
    },
    {
        id: 'adlib-sound-card',
        title: "AdLib Sound Card - FM Synthesis Audio (1987)",
        currentPrice: "$179.50",
        condition: "Used - Very Good",
        location: "Chicago, IL",
        viewItemURL: "#demo-adlib-card",
        sku: "SND-ADL-001",
        brand: "Ad Lib Inc.",
        yearManufactured: "1987",
        
        images: {
            avif: "/assets/img/fallback/adlib-sound-card.avif",
            webp: "/assets/img/fallback/adlib-sound-card.webp",
            jpg: "/assets/img/fallback/adlib-sound-card.jpg",
            alt: "AdLib Music Synthesizer Card з чипом Yamaha YM3812"
        },
        
        seoMetadata: {
            description: "AdLib - перша популярна звукова карта для PC з FM-синтезом Yamaha OPL2",
            keywords: ["AdLib", "sound card", "FM synthesis", "Yamaha YM3812", "OPL2", "vintage audio"],
            category: "Sound Cards"
        },
        
        specifications: {
            synthesis: "FM (Frequency Modulation)",
            chip: "Yamaha YM3812 (OPL2)",
            polyphony: "9 channels simultaneous",
            frequency: "49.7 kHz sampling",
            midi: "FM synthesis MIDI support",
            compatibility: "AdLib standard"
        }
    },
    {
        id: 'sound-blaster-1',
        title: "Sound Blaster 1.0 - Creative Labs Audio Card",
        currentPrice: "$249.00",
        condition: "Used - Good",
        location: "Miami, FL",
        viewItemURL: "#demo-soundblaster",
        sku: "SND-SB1-001",
        brand: "Creative Labs",
        yearManufactured: "1989",
        
        images: {
            avif: "/assets/img/fallback/sound-blaster.avif",
            webp: "/assets/img/fallback/sound-blaster.webp", 
            jpg: "/assets/img/fallback/sound-blaster.jpg",
            alt: "Creative Labs Sound Blaster 1.0 аудіо карта"
        },
        
        seoMetadata: {
            description: "Creative Sound Blaster 1.0 - революційна звукова карта з AdLib сумісністю та цифровим аудіо",
            keywords: ["Sound Blaster", "Creative Labs", "digital audio", "AdLib compatible", "vintage sound"],
            category: "Sound Cards"
        },
        
        specifications: {
            synthesis: "FM synthesis (AdLib compatible)",
            digitalAudio: "8-bit mono, up to 22 kHz",
            adlibCompatible: "Full compatibility",
            microphone: "Microphone input for recording",
            joystick: "Joystick/MIDI port",
            midi: "MIDI interface support"
        }
    },
    {
        id: 'floppy-drive-525',
        title: "IBM PC 5.25\" Floppy Drive - Tandon TM-100-2A",
        currentPrice: "$85.00",
        condition: "Used - Fair",
        location: "Denver, CO",
        viewItemURL: "#demo-floppy-drive",
        sku: "FDD-525-001",
        brand: "Tandon",
        yearManufactured: "1982",
        
        images: {
            avif: "/assets/img/fallback/floppy-drive.avif",
            webp: "/assets/img/fallback/floppy-drive.webp",
            jpg: "/assets/img/fallback/floppy-drive.jpg",
            alt: "Tandon TM-100-2A 5.25 дюймовий флопі дисковод"
        },
        
        seoMetadata: {
            description: "Tandon TM-100-2A - класичний 5.25\" флопі дисковод для IBM PC систем",
            keywords: ["5.25 floppy drive", "Tandon TM-100", "IBM PC", "vintage storage", "floppy disk"],
            category: "Storage Devices"
        },
        
        specifications: {
            diskSize: "5.25 inch floppy disks",
            capacity: "360KB double-sided",
            trackDensity: "48 TPI (Tracks Per Inch)",
            rotationSpeed: "300 RPM",
            interface: "Standard PC floppy interface",
            powerRequirement: "+5V, +12V"
        }
    },
    {
        id: 'hercules-graphics-card',
        title: "Hercules Graphics Card - Monochrome High Resolution",
        currentPrice: "$119.99",
        condition: "Used - Excellent",
        location: "Phoenix, AZ",
        viewItemURL: "#demo-hercules-card",
        sku: "GPU-HGC-001",
        brand: "Hercules",
        yearManufactured: "1982",
        
        images: {
            avif: "/assets/img/fallback/hercules-card.avif", 
            webp: "/assets/img/fallback/hercules-card.webp",
            jpg: "/assets/img/fallback/hercules-card.jpg",
            alt: "Hercules Graphics Card з роздільністю 720x348 монохром"
        },
        
        seoMetadata: {
            description: "Hercules Graphics Card - високороздільна монохромна графіка 720x348 для IBM PC",
            keywords: ["Hercules Graphics", "monochrome graphics", "720x348", "high resolution", "vintage GPU"],
            category: "Graphics Cards"
        },
        
        specifications: {
            resolution: "720x348 monochrome graphics",
            textMode: "80x25 characters",
            memory: "64KB video RAM",
            colors: "Monochrome (typically green or amber)",
            compatibility: "MDA text compatible",
            connector: "TTL monochrome monitor"
        }
    },
    {
        id: 'memory-expansion-card',
        title: "8-bit ISA Memory Expansion Card - 512KB RAM",
        currentPrice: "$65.99",
        condition: "Used - Good",
        location: "Atlanta, GA",
        viewItemURL: "#demo-memory-card",
        sku: "MEM-ISA-001",
        brand: "Generic",
        yearManufactured: "1985",
        
        images: {
            avif: "/assets/img/fallback/memory-card.avif",
            webp: "/assets/img/fallback/memory-card.webp",
            jpg: "/assets/img/fallback/memory-card.jpg",
            alt: "8-бітна ISA карта розширення пам'яті з 512КБ RAM"
        },
        
        seoMetadata: {
            description: "8-bit ISA карта розширення пам'яті 512KB для збільшення RAM в IBM PC системах",
            keywords: ["memory expansion", "512KB RAM", "8-bit ISA", "memory card", "IBM PC memory"],
            category: "Memory"
        },
        
        specifications: {
            capacity: "512KB RAM",
            memoryType: "DRAM chips",
            interface: "8-bit ISA slot",
            addressable: "Conventional or extended memory",
            configuration: "DIP switches for addressing",
            compatibility: "IBM PC/XT systems"
        }
    },
    {
        id: 'ibm-model-f-keyboard',
        title: "Original IBM PC Keyboard - Model F (1981)",
        currentPrice: "$199.50",
        condition: "Used - Very Good",
        location: "New York, NY",
        viewItemURL: "#demo-ibm-keyboard",
        sku: "KBD-MODELF-001",
        brand: "IBM",
        yearManufactured: "1981",
        
        images: {
            avif: "/assets/img/fallback/ibm-keyboard.avif",
            webp: "/assets/img/fallback/ibm-keyboard.webp",
            jpg: "/assets/img/fallback/ibm-keyboard.jpg",
            alt: "IBM Model F клавіатура з оригінального IBM PC"
        },
        
        seoMetadata: {
            description: "IBM Model F - легендарна клавіатура з оригінального IBM PC з букваписними клавішами",
            keywords: ["IBM Model F", "buckling spring", "vintage keyboard", "IBM PC keyboard", "mechanical"],
            category: "Input Devices"
        },
        
        specifications: {
            switchType: "Buckling spring mechanism",
            layout: "83-key layout",
            connector: "5-pin DIN connector",
            keyCapacity: "2-key rollover",
            weight: "Approximately 4.5 lbs",
            construction: "Steel plate, high-quality keycaps"
        }
    }
];

/**
 * Розширені утиліти для роботи з зображеннями та форматами
 */

/**
 * Детектор підтримки сучасних форматів зображень
 * Використовує прогресивне покращення з детальним логуванням
 */
class ImageFormatDetector {
    constructor() {
        this.supportCache = new Map();
        this.testImages = {
            avif: 'data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgABogQEAwgMg8f8D///8WfhwB8+ErK42A=',
            webp: 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA',
            jxl: 'data:image/jxl;base64,/woIAAAMABKIAgCQAFHUBPxVAP8BAP8BAP8BA/8qAP8pAP8bAP8XAPzrAP34AP////8='
        };
        this.initializeDetection();
    }

    /**
     * Асинхронна ініціалізація детекції підтримки форматів
     */
    async initializeDetection() {
        const detectionPromises = Object.entries(this.testImages).map(
            async ([format, dataUrl]) => {
                try {
                    const supported = await this.testFormat(format, dataUrl);
                    this.supportCache.set(format, supported);
                    return { format, supported };
                } catch (error) {
                    console.warn(`⚠️ Error testing ${format} support:`, error);
                    this.supportCache.set(format, false);
                    return { format, supported: false };
                }
            }
        );

        const results = await Promise.all(detectionPromises);
        console.log('🖼️ Image format support detection completed:', 
            Object.fromEntries(results.map(r => [r.format, r.supported]))
        );

        // Зберігаємо результати в глобальному об'єкті для доступу з інших модулів
        window.imageFormatSupport = Object.fromEntries(
            results.map(r => [r.format, r.supported])
        );

        // Відправляємо подію про завершення детекції
        window.dispatchEvent(new CustomEvent('imageFormatDetectionComplete', {
            detail: window.imageFormatSupport
        }));
    }

    /**
     * Тестує підтримку конкретного формату зображень
     */
    async testFormat(format, dataUrl) {
        return new Promise((resolve) => {
            const img = new Image();
            
            // Timeout для випадків коли браузер не підтримує формат, але й не генерує помилку
            const timeout = setTimeout(() => {
                resolve(false);
            }, 2000);

            img.onload = () => {
                clearTimeout(timeout);
                // Перевіряємо, чи зображення дійсно завантажилось (має розміри)
                resolve(img.width > 0 && img.height > 0);
            };

            img.onerror = () => {
                clearTimeout(timeout);
                resolve(false);
            };

            img.src = dataUrl;
        });
    }

    /**
     * Отримує підтримку формату (синхронно, після ініціалізації)
     */
    isSupported(format) {
        return this.supportCache.get(format) || false;
    }

    /**
     * Отримує найкращий доступний формат для зображення
     */
    getBestFormat(imageObject) {
        if (!imageObject || !imageObject.images) return null;

        const { images } = imageObject;
        
        // Пріоритет форматів: AVIF > WebP > JPG
        if (this.isSupported('avif') && images.avif) {
            return { url: images.avif, format: 'avif', type: 'image/avif' };
        }
        
        if (this.isSupported('webp') && images.webp) {
            return { url: images.webp, format: 'webp', type: 'image/webp' };
        }
        
        if (images.jpg) {
            return { url: images.jpg, format: 'jpg', type: 'image/jpeg' };
        }

        return null;
    }

    /**
     * Генерує <picture> елемент з підтримкою всіх форматів
     */
    generatePictureElement(imageObject, additionalAttributes = {}) {
        if (!imageObject || !imageObject.images) {
            return this.generatePlaceholder(imageObject?.title || 'Unknown product');
        }

        const { images } = imageObject;
        const defaultAttrs = {
            loading: 'lazy',
            decoding: 'async',
            width: '300',
            height: '200',
            ...additionalAttributes
        };

        let sourcesHtml = '';
        
        // Додаємо source елементи для кожного доступного формату
        if (images.avif) {
            sourcesHtml += `<source srcset="${images.avif}" type="image/avif">`;
        }
        
        if (images.webp) {
            sourcesHtml += `<source srcset="${images.webp}" type="image/webp">`;
        }

        // Fallback img елемент
        const imgAttributes = Object.entries(defaultAttrs)
            .map(([key, value]) => `${key}="${value}"`)
            .join(' ');

        const fallbackSrc = images.jpg || images.webp || images.avif || '';
        
        return `
            <picture class="product-image-container">
                ${sourcesHtml}
                <img src="${fallbackSrc}" 
                     alt="${images.alt || 'Product image'}"
                     ${imgAttributes}
                     onerror="this.style.display='none'; this.parentElement.classList.add('image-error');"
                     onload="this.parentElement.classList.add('image-loaded');">
            </picture>
        `;
    }

    /**
     * Генерує placeholder для відсутніх зображень
     */
    generatePlaceholder(title = 'Product') {
        return `
            <div class="product-image-placeholder" role="img" aria-label="Зображення товару недоступне">
                <div class="placeholder-content">
                    <span class="placeholder-icon">🖼️</span>
                    <span class="placeholder-text">Зображення<br>недоступне</span>
                </div>
            </div>
        `;
    }
}

/**
 * Глобальний детектор форматів зображень
 */
window.imageFormatDetector = new ImageFormatDetector();

/**
 * Утиліти для роботи з продуктами
 */
window.productUtils = {
    /**
     * Отримує випадкові товари з fallback списку
     * @param {number} count - Кількість товарів для повернення
     * @returns {Array} Масив випадкових товарів
     */
    getRandomProducts(count = 8) {
        const shuffled = [...window.fallbackProducts].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
    },

    /**
     * Фільтрує товари за категорією
     * @param {string} category - Категорія для фільтрації
     * @returns {Array} Відфільтровані товари
     */
    filterByCategory(category) {
        if (!category) return window.fallbackProducts;
        
        return window.fallbackProducts.filter(product => 
            product.seoMetadata.category.toLowerCase().includes(category.toLowerCase())
        );
    },

    /**
     * Шукає товари за ключовими словами
     * @param {string} query - Пошуковий запит
     * @returns {Array} Результати пошуку
     */
    searchProducts(query) {
        if (!query) return window.fallbackProducts;
        
        const searchTerm = query.toLowerCase();
        
        return window.fallbackProducts.filter(product => {
            const searchableText = [
                product.title,
                product.seoMetadata.description,
                product.seoMetadata.keywords.join(' '),
                product.brand,
                Object.values(product.specifications || {}).join(' ')
            ].join(' ').toLowerCase();
            
            return searchableText.includes(searchTerm);
        });
    },

    /**
     * Отримує товар за ID
     * @param {string} id - Унікальний ідентифікатор товару
     * @returns {Object|null} Товар або null
     */
    getProductById(id) {
        return window.fallbackProducts.find(product => product.id === id) || null;
    },

    /**
     * Генерує структуровані дані Schema.org для товару
     * @param {Object} product - Об'єкт товару
     * @returns {Object} JSON-LD структуровані дані
     */
    generateProductSchema(product) {
        const bestImage = window.imageFormatDetector.getBestFormat(product);
        
        return {
            "@context": "https://schema.org/",
            "@type": "Product",
            "name": product.title,
            "description": product.seoMetadata.description,
            "sku": product.sku,
            "brand": {
                "@type": "Brand",
                "name": product.brand
            },
            "image": bestImage ? bestImage.url : null,
            "offers": {
                "@type": "Offer",
                "price": product.currentPrice.replace(/[$,]/g, ''),
                "priceCurrency": "USD",
                "itemCondition": `https://schema.org/${product.condition.replace(/\s/g, '')}Condition`,
                "availability": "https://schema.org/InStock",
                "seller": {
                    "@type": "Organization", 
                    "name": "Retro-PC Store"
                }
            },
            "additionalProperty": Object.entries(product.specifications || {}).map(([key, value]) => ({
                "@type": "PropertyValue",
                "name": key,
                "value": value
            }))
        };
    }
};

/**
 * Покращені утиліти для зображень з performance моніторингом
 */
window.imageUtils = {
    /**
     * Прогресивно завантажує зображення з множинних форматів
     * @param {Object} product - Об'єкт товару з зображеннями
     * @param {Object} options - Додаткові опції
     * @returns {Promise<HTMLElement>} Promise з готовим DOM елементом
     */
    async loadOptimizedImage(product, options = {}) {
        const startTime = performance.now();
        
        try {
            const pictureElement = window.imageFormatDetector.generatePictureElement(product, options);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = pictureElement;
            const picture = tempDiv.firstElementChild;
            
            // Чекаємо на завантаження зображення
            const img = picture.querySelector('img');
            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = reject;
                
                // Якщо зображення вже завантажено
                if (img.complete) resolve();
            });
            
            const loadTime = performance.now() - startTime;
            console.log(`🖼️ Image loaded successfully in ${Math.round(loadTime)}ms:`, product.title);
            
            // Відстежуємо в аналітиці
            this.trackImageLoad(product, loadTime, true);
            
            return picture;
            
        } catch (error) {
            const loadTime = performance.now() - startTime;
            console.warn(`⚠️ Image load failed after ${Math.round(loadTime)}ms:`, product.title, error);
            
            // Відстежуємо помилку
            this.trackImageLoad(product, loadTime, false);
            
            // Повертаємо placeholder
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = window.imageFormatDetector.generatePlaceholder(product.title);
            return tempDiv.firstElementChild;
        }
    },

    /**
     * Відстежує метрики завантаження зображень
     */
    trackImageLoad(product, loadTime, success) {
        // Google Analytics event
        if (typeof gtag !== 'undefined') {
            gtag('event', 'image_load_performance', {
                event_category: 'Performance',
                event_label: success ? 'success' : 'error',
                value: Math.round(loadTime),
                custom_parameter_1: product.id,
                custom_parameter_2: success ? 'loaded' : 'failed'
            });
        }

        // Performance API entry
        try {
            performance.mark(`image-load-${success ? 'success' : 'error'}-${product.id}`);
        } catch (e) {
            // Performance API не підтримується, ігноруємо
        }
    },

    /**
     * Отримує статистику завантаження зображень
     */
    getImageLoadStats() {
        try {
            const entries = performance.getEntriesByType('mark')
                .filter(entry => entry.name.startsWith('image-load-'));
            
            const stats = {
                total: entries.length,
                successful: entries.filter(e => e.name.includes('-success-')).length,
                failed: entries.filter(e => e.name.includes('-error-')).length
            };
            
            stats.successRate = stats.total > 0 ? (stats.successful / stats.total * 100).toFixed(1) : 0;
            
            return stats;
        } catch (error) {
            return { total: 0, successful: 0, failed: 0, successRate: 0 };
        }
    }
};

/**
 * Застарілі функції для зворотної сумісності
 * @deprecated Використовуйте productUtils.getRandomProducts() замість цього
 */
window.getRandomFallbackProducts = function(count = 8) {
    console.warn('⚠️ getRandomFallbackProducts is deprecated. Use productUtils.getRandomProducts() instead.');
    return window.productUtils.getRandomProducts(count);
};

/**
 * @deprecated Використовуйте imageFormatDetector.testFormat() замість цього
 */
window.checkImageFormatSupport = function(format) {
    console.warn('⚠️ checkImageFormatSupport is deprecated. Use imageFormatDetector.testFormat() instead.');
    return window.imageFormatDetector.testFormat(format, window.imageFormatDetector.testImages[format]);
};

/**
 * Ініціалізація та фінальне логування
 */
(function initializeFallbackData() {
    console.log('📦 Fallback products v3.1 loaded:', window.fallbackProducts.length, 'items');
    console.log('🚀 Enhanced utilities available:');
    console.log('   - window.productUtils (search, filter, schemas)');
    console.log('   - window.imageUtils (optimized loading, analytics)');
    console.log('   - window.imageFormatDetector (format detection)');
    
    // Додаємо глобальний обробник для кешування ресурсів
    if ('serviceWorker' in navigator) {
        console.log('💾 Service Worker support detected - ready for advanced caching');
    }

    // Відстежуємо загальну ініціалізацію
    if (typeof gtag !== 'undefined') {
        gtag('event', 'fallback_data_initialized', {
            event_category: 'Performance',
            event_label: 'v3.1',
            value: window.fallbackProducts.length
        });
    }
})();